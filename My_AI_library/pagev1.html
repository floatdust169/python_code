<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIæ™ºèƒ½çŸ¥è¯†åº“æ£€ç´¢ç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            accent: '#722ED1',
            neutral: '#F2F3F5',
            'neutral-dark': '#4E5969',
            success: '#52C41A',
            warning: '#FAAD14',
            danger: '#FF4D4F',
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .message-bubble-left {
        border-radius: 18px 18px 18px 0;
      }
      .message-bubble-right {
        border-radius: 18px 18px 0 18px;
      }
      .hover-lift {
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .hover-lift:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }
      .loading-shimmer {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }
      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }
    }
  </style>
</head>

<body class="font-inter bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <header class="bg-white shadow-sm sticky top-0 z-40">
    <div class="container mx-auto px-4 py-3 flex items-center justify-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-database text-primary text-2xl"></i>
        <h1 class="text-xl md:text-2xl font-bold text-primary">AIæ™ºèƒ½çŸ¥è¯†åº“æ£€ç´¢ç³»ç»Ÿ</h1>
      </div>
    </div>
  </header>

  <!-- é€šçŸ¥æç¤ºæ¡† -->
  <div id="notification"
    class="fixed top-16 right-4 bg-white shadow-lg rounded-lg p-4 transform translate-x-full transition-transform duration-300 flex items-center z-50 max-w-xs">
    <i id="notificationIcon" class="fa fa-check-circle text-success text-xl mr-3"></i>
    <div>
      <h4 id="notificationTitle" class="font-medium text-gray-800">æ“ä½œæˆåŠŸ</h4>
      <p id="notificationMessage" class="text-sm text-gray-500">çŸ¥è¯†åº“å·²æ·»åŠ </p>
    </div>
    <button id="closeNotification" class="ml-4 text-gray-400 hover:text-gray-600">
      <i class="fa fa-times"></i>
    </button>
  </div>

  <!-- åŠ è½½æç¤ºæ¡† -->
  <div id="loadingModal" class="fixed inset-0 bg-black/30 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl shadow-lg p-5 flex items-center">
      <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary mr-3"></div>
      <p id="loadingText" class="text-gray-700">æ­£åœ¨å¤„ç†...</p>
    </div>
  </div>

  <!-- æ·»åŠ çŸ¥è¯†åº“å¼¹çª— -->
  <div id="addKnowledgeModal" class="fixed inset-0 bg-black/30 z-50 flex items-center justify-center hidden">
    <div id="modalContent"
      class="bg-white rounded-xl shadow-lg w-full max-w-md mx-4 transform scale-95 opacity-0 transition-all duration-300">
      <div class="p-5 border-b border-gray-100">
        <h3 class="text-lg font-semibold">æ·»åŠ æ–°çŸ¥è¯†åº“</h3>
      </div>
      <div class="p-5">
        <div class="mb-4">
          <label for="knowledgeName" class="block text-sm font-medium text-gray-700 mb-1">çŸ¥è¯†åº“åç§° <span
              class="text-danger">*</span></label>
          <input type="text" id="knowledgeName"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
            placeholder="è¾“å…¥çŸ¥è¯†åº“åç§°">
          <p id="nameError" class="mt-1 text-sm text-danger hidden">è¯·è¾“å…¥çŸ¥è¯†åº“åç§°</p>
        </div>
        <div class="mb-4">
          <label for="knowledgeDesc" class="block text-sm font-medium text-gray-700 mb-1">çŸ¥è¯†åº“æè¿°</label>
          <textarea id="knowledgeDesc" rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
            placeholder="è¾“å…¥çŸ¥è¯†åº“æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
        </div>
        <div class="mb-5">
          <label for="knowledgePrompt" class="block text-sm font-medium text-gray-700 mb-1">AIæç¤ºè¯</label>
          <textarea id="knowledgePrompt" rows="4"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm"
            placeholder="è®¾ç½®AIåŠ©æ‰‹çš„è§’è‰²å’Œå›ç­”é£æ ¼ï¼Œä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ€æœ¯æ–‡æ¡£åŠ©æ‰‹ï¼Œè¯·åŸºäºæ–‡æ¡£å†…å®¹å‡†ç¡®å›ç­”ç”¨æˆ·é—®é¢˜...">ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çŸ¥è¯†åº“åŠ©æ‰‹ï¼Œè¯·æ ¹æ®æä¾›çš„æ–‡æ¡£å†…å®¹å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚</textarea>
          <div class="flex justify-between items-center mt-1">
            <span class="text-xs text-gray-400">
              <span id="addPromptCharCount">48</span> / 500å­—ç¬¦
            </span>
          </div>
        </div>
      </div>
      <div class="p-4 bg-gray-50 rounded-b-xl flex justify-end space-x-3">
        <button id="cancelCreateBtn"
          class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">å–æ¶ˆ</button>
        <button id="createKnowledgeBtn"
          class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">åˆ›å»º</button>
      </div>
    </div>
  </div>

  <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
  <div id="deleteConfirmModal" class="fixed inset-0 bg-black/30 z-50 flex items-center justify-center hidden">
    <div id="deleteModalContent"
      class="bg-white rounded-xl shadow-lg w-full max-w-md mx-4 transform scale-95 opacity-0 transition-all duration-300">
      <div class="p-5 border-b border-gray-100">
        <h3 class="text-lg font-semibold text-danger flex items-center">
          <i class="fa fa-exclamation-circle mr-2"></i>ç¡®è®¤åˆ é™¤
        </h3>
      </div>
      <div class="p-5">
        <p class="text-gray-700 mb-4">æ‚¨ç¡®å®šè¦åˆ é™¤çŸ¥è¯†åº“ <span id="deleteKnowledgeName" class="font-medium"></span> å—ï¼Ÿ</p>
        <p class="text-sm text-gray-500">åˆ é™¤åï¼Œè¯¥çŸ¥è¯†åº“ä¸­çš„æ‰€æœ‰æ–‡æ¡£å°†è¢«æ°¸ä¹…åˆ é™¤ï¼Œä¸å¯æ¢å¤ã€‚</p>
      </div>
      <div class="p-4 bg-gray-50 rounded-b-xl flex justify-end space-x-3">
        <button id="cancelDeleteBtn"
          class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">å–æ¶ˆ</button>
        <button id="confirmDeleteBtn"
          class="px-4 py-2 bg-danger text-white rounded-lg hover:bg-danger/90 transition-colors">ç¡®è®¤åˆ é™¤</button>
      </div>
    </div>
  </div>

  <!-- ä¸»å†…å®¹åŒº -->
  <main class="flex-grow container mx-auto px-4 py-6 flex flex-col md:flex-row gap-6">

    <!-- å·¦ä¾§çŸ¥è¯†åº“é€‰æ‹©é¢æ¿ -->
    <div class="md:w-64 lg:w-72 flex-shrink-0">
      <div class="bg-white rounded-xl shadow-sm p-4 sticky top-20">
        <h2 class="text-lg font-semibold mb-3 flex items-center">
          <i class="fa fa-folder-open text-primary mr-2"></i>çŸ¥è¯†åº“åˆ—è¡¨
        </h2>

        <div class="mb-3">
          <button id="addKnowledgeBtn"
            class="w-full flex items-center justify-center bg-primary text-white py-2 px-3 rounded-lg hover:bg-primary/90 transition-all text-sm hover-lift">
            <i class="fa fa-plus mr-2"></i>æ·»åŠ çŸ¥è¯†åº“
          </button>
        </div>

        <!-- åˆå§‹ç©ºç™½çŠ¶æ€æç¤º -->
        <div id="emptyKnowledgeState" class="py-8 text-center">
          <i class="fa fa-folder-o text-gray-300 text-4xl mb-3"></i>
          <p class="text-gray-500 text-sm">æš‚æ— çŸ¥è¯†åº“</p>
          <p class="text-gray-400 text-xs mt-1">ç‚¹å‡»"æ·»åŠ çŸ¥è¯†åº“"å¼€å§‹åˆ›å»º</p>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="knowledgeLoadingState" class="py-8 text-center hidden">
          <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary mx-auto mb-3"></div>
          <p class="text-gray-500 text-sm">åŠ è½½çŸ¥è¯†åº“ä¸­...</p>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div id="fileUploadArea" class="mb-4 hidden">
          <h3 class="text-xs text-gray-500 mb-2 px-3">å¯ä¸Šä¼ æ–‡æ¡£è‡³å½“å‰çŸ¥è¯†åº“</h3>
          <div id="dropArea"
            class="border-2 border-dashed border-gray-300 rounded-lg p-3 text-center hover:border-primary transition-colors cursor-pointer bg-gray-50 text-sm">
            <i class="fa fa-upload text-primary mr-1"></i>
            <span class="text-primary">ä¸Šä¼ æ–‡æ¡£</span>
            <input type="file" id="fileInput" class="hidden" multiple accept=".pdf,.doc,.docx,.txt">
          </div>
        </div>

        <!-- çŸ¥è¯†åº“åˆ—è¡¨ -->
        <div id="knowledgeBasesList"
          class="space-y-1 max-h-[calc(100vh-480px)] overflow-y-auto scrollbar-hide pr-2 hidden">
          <!-- çŸ¥è¯†åº“é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- æç¤ºè¯è®¾ç½®åŒºåŸŸ -->
        <div id="promptSettingsArea" class="mt-4 hidden">
          <div class="border-t border-gray-200 pt-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
              <i class="fa fa-magic text-secondary mr-2"></i>AI æç¤ºè¯è®¾ç½®
            </h3>
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="text-xs text-gray-600 mb-2" id="currentKnowledgePromptLabel">
                å½“å‰çŸ¥è¯†åº“ï¼š<span class="font-medium"></span>
              </div>
              <textarea id="promptTextarea" 
                placeholder="è®¾ç½®AIåŠ©æ‰‹çš„è§’è‰²å’Œå›ç­”é£æ ¼ï¼Œä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ€æœ¯æ–‡æ¡£åŠ©æ‰‹ï¼Œè¯·åŸºäºæ–‡æ¡£å†…å®¹å‡†ç¡®å›ç­”ç”¨æˆ·é—®é¢˜..."
                class="w-full px-3 py-2 text-xs border border-gray-200 rounded-md focus:border-secondary focus:ring-1 focus:ring-secondary/20 outline-none resize-none"
                rows="4"></textarea>
              <div class="flex justify-between items-center mt-2">
                <span class="text-xs text-gray-400">
                  <span id="promptCharCount">0</span> / 500å­—ç¬¦
                </span>
                <div class="space-x-2">
                  <button id="resetPromptBtn" 
                    class="text-xs px-2 py-1 text-gray-600 hover:text-gray-800 transition-colors">
                    é‡ç½®
                  </button>
                  <button id="savePromptBtn" 
                    class="text-xs px-3 py-1 bg-secondary text-white rounded-md hover:bg-secondary/90 transition-colors">
                    ä¿å­˜
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å³ä¾§å¯¹è¯å†…å®¹åŒºåŸŸ -->
    <div class="flex-grow flex flex-col max-h-[calc(100vh-64px)]">
      <!-- å¯¹è¯æ¶ˆæ¯åŒºåŸŸ -->
      <div id="messagesContainer" class="flex-grow overflow-y-auto p-2 scrollbar-hide">
        <!-- åˆå§‹æ¬¢è¿æ¶ˆæ¯ï¼ˆæ— çŸ¥è¯†åº“çŠ¶æ€ï¼‰ -->
        <div id="initialWelcomeMessage" class="flex items-start mb-6 mt-2">
          <div class="flex-shrink-0 w-8 h-8 rounded-full overflow-hidden">
            <img src="pic/Book.png" alt="æ™ºèƒ½åŠ©æ‰‹" class="w-full h-full object-cover">
          </div>
          <div class="ml-3 max-w-[85%]">
            <div class="bg-primary/10 p-4 message-bubble-left">
              <p class="text-gray-800">æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½çŸ¥è¯†åº“æ£€ç´¢åŠ©æ‰‹ã€‚</p>
              <p class="mt-2 text-gray-700">æ‚¨å½“å‰è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•çŸ¥è¯†åº“ï¼Œè¯·å…ˆç‚¹å‡»å·¦ä¾§çš„"æ·»åŠ çŸ¥è¯†åº“"æŒ‰é’®åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªçŸ¥è¯†åº“ï¼Œç„¶åå°±å¯ä»¥ä¸Šä¼ æ–‡æ¡£å¹¶è¿›è¡Œæ£€ç´¢æŸ¥è¯¢äº†ã€‚</p>
            </div>
            <span class="text-xs text-gray-400 ml-3 mt-1 block">ç³»ç»Ÿ</span>
          </div>
        </div>

        <!-- æœ‰çŸ¥è¯†åº“æ—¶çš„æ¬¢è¿æ¶ˆæ¯ -->
        <div id="knowledgeWelcomeMessage" class="flex items-start mb-6 mt-2 hidden">
          <div class="flex-shrink-0 w-8 h-8 rounded-full overflow-hidden">
            <img src="pic/Book.png" alt="æ™ºèƒ½åŠ©æ‰‹" class="w-full h-full object-cover">
          </div>
          <div class="ml-3 max-w-[85%]">
            <div class="bg-primary/10 p-4 message-bubble-left">
              <p class="text-gray-800">æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½çŸ¥è¯†åº“æ£€ç´¢åŠ©æ‰‹ï¼Œæ‚¨å¯ä»¥æŸ¥è¯¢ä»¥ä¸‹çŸ¥è¯†åº“çš„å†…å®¹ï¼š</p>
              <ul id="welcomeKnowledgeList" class="mt-2 ml-4 list-disc text-gray-700 text-sm">
                <!-- æ¬¢è¿æ¶ˆæ¯ä¸­çš„çŸ¥è¯†åº“åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
              </ul>
              <p class="mt-2 text-sm text-gray-600">è¯·é€‰æ‹©ä¸€ä¸ªçŸ¥è¯†åº“ï¼Œç„¶åè¾“å…¥æ‚¨çš„æŸ¥è¯¢å†…å®¹ï¼Œæˆ‘ä¼šä¸ºæ‚¨æ‰¾åˆ°ç›¸å…³ä¿¡æ¯ã€‚</p>
            </div>
            <span class="text-xs text-gray-400 ml-3 mt-1 block">ç³»ç»Ÿ</span>
          </div>
        </div>

        <!-- å¯¹è¯å†…å®¹å®¹å™¨ -->
        <div id="conversationContainer">
          <!-- å¯¹è¯å†…å®¹ä¼šåœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
        </div>

        <!-- åŠ è½½æ›´å¤šæç¤º -->
        <div class="text-center py-4">
          <button id="loadMoreBtn"
            class="text-primary text-sm hover:text-primary/80 transition-colors flex items-center mx-auto hidden">
            <i class="fa fa-history mr-1"></i> åŠ è½½æ›´å¤šå†å²
          </button>
        </div>
      </div>

      <!-- æœç´¢è¾“å…¥åŒºåŸŸ -->
      <div id="searchArea" class="bg-white rounded-xl shadow-sm p-4 mt-4 opacity-50 pointer-events-none">
        <div class="relative">
          <textarea id="searchInput" placeholder="è¯·å…ˆåˆ›å»ºå¹¶é€‰æ‹©ä¸€ä¸ªçŸ¥è¯†åº“..."
            class="w-full px-4 py-3 pr-16 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all resize-none"
            rows="2" disabled></textarea>
          <div class="absolute right-3 bottom-3 flex items-center space-x-2">
            <button id="clearBtn" class="text-gray-400 hover:text-gray-600 text-sm px-2 py-1 rounded hover:bg-gray-100 transition-all" title="æ¸…ç©ºå†…å®¹">
              <i class="fa fa-times"></i>
            </button>
            <span class="text-gray-400 text-sm">
              <span id="charCount">0</span> / 500
            </span>
          </div>
        </div>

        <!-- æŒ‰é’®åŒºåŸŸå’Œæç¤ºæ–‡æœ¬ -->
        <div class="mt-3 flex justify-between items-center">
          <div class="text-sm text-gray-500" id="currentKnowledgeæç¤º">
            æŸ¥æ‰¾å†…å®¹æ¥è‡ªå½“å‰æ‰€é€‰çŸ¥è¯†åº“
          </div>

          <button id="searchBtn"
            class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center"
            disabled>
            <span>å‘é€</span>
            <i class="fa fa-paper-plane ml-2"></i>
          </button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // APIåŸºç¡€åœ°å€ - å…¬ç½‘æœåŠ¡å™¨
    const API_BASE_URL = 'http://152.136.167.211:5000/api';

    // çŸ¥è¯†åº“æ•°æ® - ä»åç«¯è·å–
    let knowledgeBases = [];

    // å½“å‰é€‰ä¸­çš„çŸ¥è¯†åº“
    let currentKnowledgeBase = null;

    // å¯¹è¯å†å²
    let conversationHistory = [];

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading(text = "æ­£åœ¨å¤„ç†...") {
      const loadingModal = document.getElementById('loadingModal');
      const loadingText = document.getElementById('loadingText');
      loadingText.textContent = text;
      loadingModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // éšè—åŠ è½½çŠ¶æ€
    function hideLoading() {
      const loadingModal = document.getElementById('loadingModal');
      loadingModal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // å°è£…APIè¯·æ±‚
    async function apiRequest(url, method = 'GET', data = null, isFormData = false) {
      const options = {
        method,
        headers: {},
      };

      // FormDataä¸éœ€è¦è®¾ç½®Content-Typeï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¤„ç†
      if (!isFormData) {
        options.headers['Content-Type'] = 'application/json';
      }

      if (data) {
        options.body = isFormData ? data : JSON.stringify(data);
      }

      try {
        const response = await fetch(`${API_BASE_URL}${url}`, options);

        // å¤„ç†éJSONå“åº”
        let result;
        try {
          result = await response.json();
        } catch (e) {
          result = { error: `æœåŠ¡å™¨è¿”å›æ ¼å¼é”™è¯¯: ${e.message}` };
        }

        if (!response.ok) {
          throw new Error(result.error || `è¯·æ±‚å¤±è´¥ (${response.status})`);
        }

        return result;
      } catch (err) {
        console.error('APIè¯·æ±‚é”™è¯¯:', err);
        showNotification('æ“ä½œå¤±è´¥', err.message, 'error');
        throw err;
      }
    }

    // ä»åç«¯åŠ è½½çŸ¥è¯†åº“
    async function loadKnowledgeBases() {
      try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('emptyKnowledgeState').classList.add('hidden');
        document.getElementById('knowledgeBasesList').classList.add('hidden');
        document.getElementById('knowledgeLoadingState').classList.remove('hidden');

        // è°ƒç”¨APIè·å–çŸ¥è¯†åº“åˆ—è¡¨
        knowledgeBases = await apiRequest('/knowledge');

        // æ›´æ–°UI
        renderKnowledgeBases();
      } catch (err) {
        console.error('åŠ è½½çŸ¥è¯†åº“å¤±è´¥:', err);
        document.getElementById('knowledgeLoadingState').classList.add('hidden');
        document.getElementById('emptyKnowledgeState').classList.remove('hidden');
      }
    }

    // æ›´æ–°æœç´¢æ¡†æç¤ºæ–‡å­—å’Œå½“å‰çŸ¥è¯†åº“æç¤º
    function updateSearchPlaceholder() {
      const searchInput = document.getElementById('searchInput');
      const currentKnowledgeæç¤º = document.getElementById('currentKnowledgeæç¤º');

      // å½“æ²¡æœ‰çŸ¥è¯†åº“æ—¶ï¼Œæ˜¾ç¤ºåˆå§‹æç¤º
      if (knowledgeBases.length === 0) {
        searchInput.placeholder = "è¯·å…ˆåˆ›å»ºå¹¶é€‰æ‹©ä¸€ä¸ªçŸ¥è¯†åº“...";
        currentKnowledgeæç¤º.textContent = "æŸ¥æ‰¾å†…å®¹æ¥è‡ªå½“å‰æ‰€é€‰çŸ¥è¯†åº“";
        return;
      }

      // å½“æœ‰çŸ¥è¯†åº“ä½†æ²¡æœ‰é€‰ä¸­æ—¶ï¼Œé€‰ä¸­ç¬¬ä¸€ä¸ªå¹¶æ›´æ–°æç¤º
      if (!currentKnowledgeBase || !knowledgeBases.some(b => b._id === currentKnowledgeBase)) {
        currentKnowledgeBase = knowledgeBases[0]._id;
      }

      // å½“æœ‰é€‰ä¸­çš„çŸ¥è¯†åº“æ—¶ï¼Œæ˜¾ç¤ºå¯¹åº”çš„æç¤º
      const currentBase = knowledgeBases.find(b => b._id === currentKnowledgeBase);
      if (currentBase) {
        searchInput.placeholder = `åœ¨'${currentBase.name}'ä¸­æŸ¥æ‰¾`;
        currentKnowledgeæç¤º.textContent = `æŸ¥æ‰¾å†…å®¹æ¥è‡ªå½“å‰æ‰€é€‰'${currentBase.name}'åº“`;
      }
    }

    // æ›´æ–°æ¬¢è¿æ¶ˆæ¯ä¸­çš„çŸ¥è¯†åº“åˆ—è¡¨
    function updateWelcomeKnowledgeList() {
      const listContainer = document.getElementById('welcomeKnowledgeList');
      listContainer.innerHTML = '';

      knowledgeBases.forEach(base => {
        const item = document.createElement('li');
        item.textContent = base.name;
        listContainer.appendChild(item);
      });
    }

    // æ¸²æŸ“çŸ¥è¯†åº“åˆ—è¡¨
    function renderKnowledgeBases() {
      const listContainer = document.getElementById('knowledgeBasesList');
      const emptyState = document.getElementById('emptyKnowledgeState');
      const fileUploadArea = document.getElementById('fileUploadArea');
      const searchArea = document.getElementById('searchArea');
      const searchInput = document.getElementById('searchInput');
      const searchBtn = document.getElementById('searchBtn');
      const initialWelcome = document.getElementById('initialWelcomeMessage');
      const knowledgeWelcome = document.getElementById('knowledgeWelcomeMessage');
      const loadingState = document.getElementById('knowledgeLoadingState');
      const currentKnowledgeæç¤º = document.getElementById('currentKnowledgeæç¤º'); // æ–°å¢ï¼šè·å–æç¤ºæ–‡æœ¬å…ƒç´ 

      // 1. å…ˆéšè—åŠ è½½çŠ¶æ€ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥éƒ½è¦éšè—ï¼‰
      loadingState.classList.add('hidden');

      // 2. å¼ºåˆ¶æ›´æ–°æç¤ºæ–‡æœ¬ï¼ˆé¿å…é€‰ä¸­çŠ¶æ€ä¸åŒæ­¥ï¼‰
      updateSearchPlaceholder();

      // 3. æ ¹æ®æ•°æ®é•¿åº¦åˆ¤æ–­æ˜¾ç¤ºçŠ¶æ€ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šç¡®ä¿æœ‰æ•°æ®æ—¶æ˜¾ç¤ºåˆ—è¡¨ï¼‰
      if (knowledgeBases && knowledgeBases.length > 0) {
        // âœ… æœ‰çŸ¥è¯†åº“ï¼šæ˜¾ç¤ºåˆ—è¡¨ + éšè—ç©ºçŠ¶æ€ + å¯ç”¨åŠŸèƒ½
        listContainer.classList.remove('hidden'); // æ˜¾ç¤ºåˆ—è¡¨å®¹å™¨
        emptyState.classList.add('hidden');      // éšè—ç©ºæç¤º
        fileUploadArea.classList.remove('hidden');// æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ åŒº
        initialWelcome.classList.add('hidden');  // éšè—åˆå§‹æ¬¢è¿è¯­
        knowledgeWelcome.classList.remove('hidden');// æ˜¾ç¤ºæœ‰åº“æ¬¢è¿è¯­
        searchArea.classList.remove('opacity-50', 'pointer-events-none'); // å¯ç”¨æœç´¢åŒº

        // å¯ç”¨æœç´¢æ¡†ç›¸å…³åŠŸèƒ½
        searchInput.disabled = false;
        searchBtn.disabled = false;

        // âœ… æ›´æ–°æ¬¢è¿æ¶ˆæ¯ä¸­çš„çŸ¥è¯†åº“åˆ—è¡¨
        updateWelcomeKnowledgeList();

        // âœ… ç¡®ä¿æœ‰é€‰ä¸­çš„çŸ¥è¯†åº“ï¼ˆå¦‚æœæ²¡æœ‰ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªï¼‰
        if (!currentKnowledgeBase || !knowledgeBases.some(b => b._id === currentKnowledgeBase)) {
          currentKnowledgeBase = knowledgeBases[0]._id;
          // åŒæ­¥æ›´æ–°æç¤ºæ–‡æœ¬ï¼ˆé€‰ä¸­ç¬¬ä¸€ä¸ªåç«‹å³æ˜¾ç¤ºï¼‰
          const firstBase = knowledgeBases[0];
          currentKnowledgeæç¤º.textContent = `æŸ¥æ‰¾å†…å®¹æ¥è‡ªå½“å‰æ‰€é€‰${firstBase.name}åº“`;
        }

        // âœ… ä¿®å¤é—®é¢˜1ï¼šç¡®ä¿æç¤ºè¯è®¾ç½®ç»„ä»¶åœ¨æœ‰çŸ¥è¯†åº“æ—¶æ˜¾ç¤º
        updatePromptSettings();

        // âœ… æ¸…ç©ºåˆ—è¡¨å®¹å™¨ï¼ˆé¿å…é‡å¤æ¸²æŸ“ï¼‰ï¼Œé‡æ–°æ¸²æŸ“æ¯ä¸ªçŸ¥è¯†åº“é¡¹
        listContainer.innerHTML = '';
        knowledgeBases.forEach(base => {
          // åˆ›å»ºå•ä¸ªçŸ¥è¯†åº“é¡¹çš„DOM
          const item = document.createElement('div');
          // å…³é”®ï¼šé€‰ä¸­çŠ¶æ€çš„æ ·å¼ç±»è¦æ­£ç¡®ç»‘å®šï¼ˆæ ¹æ®currentKnowledgeBaseåˆ¤æ–­ï¼‰
          item.className = `flex items-center p-2 rounded-lg transition-colors ${base._id === currentKnowledgeBase ? 'bg-primary/10 text-primary' : 'hover:bg-neutral'
            }`;
          // çŸ¥è¯†åº“é¡¹çš„å†…å®¹ï¼ˆå•é€‰æ¡† + åç§° + æŒ‰é’®ï¼‰
          item.innerHTML = `
        <input type="radio" name="knowledgeBase" value="${base._id}" 
               class="mr-3 text-primary focus:ring-primary" 
               ${base._id === currentKnowledgeBase ? 'checked' : ''}>
        <span class="flex-grow truncate">${base.name}</span>
        <!-- è¯¦æƒ…æŒ‰é’® -->
        <button class="detail-knowledge-btn text-gray-400 hover:text-primary p-1 mr-1" 
                data-id="${base._id}" title="æŸ¥çœ‹è¯¦æƒ…">
          ğŸ‘ï¸
        </button>
        <!-- åˆ é™¤æŒ‰é’® -->
        <button class="delete-knowledge-btn text-gray-400 hover:text-danger p-1 ml-1" 
                data-id="${base._id}" title="åˆ é™¤çŸ¥è¯†åº“">
          ğŸ—‘ï¸
        </button>
      `;

          // âœ… ç»‘å®šå•é€‰æ¡†åˆ‡æ¢äº‹ä»¶ï¼ˆåˆ‡æ¢çŸ¥è¯†åº“æ—¶æ›´æ–°çŠ¶æ€ï¼‰
          const radioBtn = item.querySelector('input');
          radioBtn.addEventListener('change', (e) => {
            if (e.target.checked && base._id !== currentKnowledgeBase) {
              currentKnowledgeBase = base._id;
              // é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼ˆæ›´æ–°é€‰ä¸­æ ·å¼ï¼‰
              renderKnowledgeBases();
              // æ›´æ–°æç¤ºè¯è®¾ç½®
              updatePromptSettings();
              // æ˜¾ç¤ºåˆ‡æ¢æˆåŠŸçš„é€šçŸ¥
              showNotification('å·²åˆ‡æ¢çŸ¥è¯†åº“', `å½“å‰çŸ¥è¯†åº“: ${base.name}`, 'info');
            }
          });

          // è¯¦æƒ…æŒ‰é’®äº‹ä»¶ï¼ˆå¯é€‰ï¼Œä¸å½±å“åˆ—è¡¨æ˜¾ç¤ºï¼‰
          item.querySelector('.detail-knowledge-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            showNotification('æç¤º', `çŸ¥è¯†åº“: ${base.name}\næè¿°: ${base.description || 'æ— '}`, 'info');
          });

          // åˆ é™¤æŒ‰é’®äº‹ä»¶ï¼ˆå¯é€‰ï¼Œä¸å½±å“åˆ—è¡¨æ˜¾ç¤ºï¼‰
          item.querySelector('.delete-knowledge-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            openDeleteConfirmModal(base._id, base.name);
          });

          // âœ… å…³é”®ï¼šå°†åˆ›å»ºå¥½çš„çŸ¥è¯†åº“é¡¹æ·»åŠ åˆ°åˆ—è¡¨å®¹å™¨ä¸­ï¼ˆä¹‹å‰å¯èƒ½æ¼äº†è¿™æ­¥ï¼‰
          listContainer.appendChild(item);
        });

      } else {
        // âŒ æ— çŸ¥è¯†åº“ï¼šæ˜¾ç¤ºç©ºçŠ¶æ€ + éšè—åˆ—è¡¨ + ç¦ç”¨åŠŸèƒ½
        listContainer.classList.add('hidden');
        emptyState.classList.remove('hidden');
        fileUploadArea.classList.add('hidden');
        initialWelcome.classList.remove('hidden');
        knowledgeWelcome.classList.add('hidden');
        searchArea.classList.add('opacity-50', 'pointer-events-none');
        searchInput.disabled = true;
        searchBtn.disabled = true;
      }
    }

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(title, message, type = 'success') {
      const notification = document.getElementById('notification');
      const notificationTitle = document.getElementById('notificationTitle');
      const notificationMessage = document.getElementById('notificationMessage');
      const notificationIcon = document.getElementById('notificationIcon');

      notificationTitle.textContent = title;
      notificationMessage.textContent = message;

      notificationIcon.className = '';
      if (type === 'success') {
        notificationIcon.className = 'fa fa-check-circle text-success text-xl mr-3';
      } else if (type === 'error') {
        notificationIcon.className = 'fa fa-exclamation-circle text-danger text-xl mr-3';
      } else if (type === 'warning') {
        notificationIcon.className = 'fa fa-exclamation-triangle text-warning text-xl mr-3';
      } else if (type === 'info') {
        notificationIcon.className = 'fa fa-info-circle text-primary text-xl mr-3';
      }

      notification.classList.remove('translate-x-full');

      // ç‚¹å‡»å…³é—­æŒ‰é’®
      document.getElementById('closeNotification').onclick = hideNotification;
    }

    // éšè—é€šçŸ¥
    function hideNotification() {
      const notification = document.getElementById('notification');
      notification.classList.add('translate-x-full');
    }

    // æ‰“å¼€åˆ é™¤ç¡®è®¤å¼¹çª—
    function openDeleteConfirmModal(id, name) {
      const modal = document.getElementById('deleteConfirmModal');
      const modalContent = document.getElementById('deleteModalContent');
      const knowledgeNameEl = document.getElementById('deleteKnowledgeName');

      knowledgeNameEl.textContent = name;
      knowledgeNameEl.dataset.id = id;

      modal.classList.remove('hidden');
      setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
      }, 10);

      // å–æ¶ˆæŒ‰é’®äº‹ä»¶
      document.getElementById('cancelDeleteBtn').onclick = () => {
        closeDeleteConfirmModal();
      };
    }

    // å…³é—­åˆ é™¤ç¡®è®¤å¼¹çª—
    function closeDeleteConfirmModal() {
      const modal = document.getElementById('deleteConfirmModal');
      const modalContent = document.getElementById('deleteModalContent');

      modalContent.classList.remove('scale-100', 'opacity-100');
      modalContent.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 300);
    }

    // åˆ›å»ºçŸ¥è¯†åº“ï¼ˆå¯¹æ¥APIï¼‰
    async function createKnowledgeBase(name, description, prompt) {
      try {
        showLoading("åˆ›å»ºçŸ¥è¯†åº“ä¸­...");

        // è°ƒç”¨APIåˆ›å»ºçŸ¥è¯†åº“
        const result = await apiRequest('/knowledge', 'POST', {
          'åº“å': name,
          'åº“æè¿°': description,
          'æç¤ºè¯': prompt || 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çŸ¥è¯†åº“åŠ©æ‰‹ï¼Œè¯·æ ¹æ®æä¾›çš„æ–‡æ¡£å†…å®¹å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚'
        });

        hideLoading();

        // åˆ·æ–°çŸ¥è¯†åº“åˆ—è¡¨
        await loadKnowledgeBases();
        showNotification('åˆ›å»ºæˆåŠŸ', `çŸ¥è¯†åº“"${name}"å·²åˆ›å»º`, 'success');
        return result.id;
      } catch (err) {
        hideLoading();
        console.error('åˆ›å»ºçŸ¥è¯†åº“å¤±è´¥:', err);
        return null;
      }
    }

    // åˆ é™¤çŸ¥è¯†åº“ï¼ˆå¯¹æ¥APIï¼‰
    async function deleteKnowledgeBase(id) {
      try {
        showLoading("åˆ é™¤çŸ¥è¯†åº“ä¸­...");

        // è°ƒç”¨APIåˆ é™¤çŸ¥è¯†åº“
        await apiRequest('/knowledge', 'DELETE', { 'id': id });

        hideLoading();

        // åˆ·æ–°çŸ¥è¯†åº“åˆ—è¡¨
        await loadKnowledgeBases();
        showNotification('åˆ é™¤æˆåŠŸ', 'çŸ¥è¯†åº“å·²æ°¸ä¹…åˆ é™¤', 'info');
        return true;
      } catch (err) {
        hideLoading();
        console.error('åˆ é™¤çŸ¥è¯†åº“å¤±è´¥:', err);
        return false;
      }
    }

    // ä¸Šä¼ æ–‡ä»¶ï¼ˆå¯¹æ¥APIï¼‰
    async function uploadFileToKnowledge(knowledgeId, file) {
      try {
        showLoading("æ–‡ä»¶ä¸Šä¼ ä¸­...");

        const formData = new FormData();
        formData.append('knowledge_id', knowledgeId);
        formData.append('file', file);

        // è°ƒç”¨APIä¸Šä¼ æ–‡ä»¶
        const result = await apiRequest('/upload', 'POST', formData, true);

        hideLoading();

        // åˆ·æ–°çŸ¥è¯†åº“æ–‡æ¡£è®¡æ•°
        await loadKnowledgeBases();
        showNotification('ä¸Šä¼ æˆåŠŸ', `æ–‡ä»¶"${file.name}"å·²ä¸Šä¼ `, 'success');
        return result.file_id;
      } catch (err) {
        hideLoading();
        console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', err);
        return null;
      }
    }

    // æ›´æ–°çŸ¥è¯†åº“æç¤ºè¯
    async function updateKnowledgePrompt(knowledgeId, prompt) {
      try {
        showLoading("ä¿å­˜æç¤ºè¯ä¸­...");

        // æ–¹æ¡ˆ1ï¼šä½¿ç”¨ä¸“é—¨çš„POSTæ¥å£æ›´æ–°æç¤ºè¯
        await apiRequest('/knowledge/update_prompt', 'POST', {
          'id': knowledgeId,
          'prompt': prompt
        });

        hideLoading();

        // æ›´æ–°æœ¬åœ°æ•°æ®
        const knowledge = knowledgeBases.find(kb => kb._id === knowledgeId);
        if (knowledge) {
          knowledge.prompt = prompt;
        }

        showNotification('ä¿å­˜æˆåŠŸ', 'æç¤ºè¯å·²æ›´æ–°', 'success');
        return true;

      } catch (err) {
        // å°è¯•æ–¹æ¡ˆ2ï¼šä½¿ç”¨PUTæ–¹æ³•
        try {
          showLoading("å°è¯•PUTæ–¹æ³•ä¿å­˜...");
          
          await apiRequest(`/knowledge/${knowledgeId}/prompt`, 'PUT', {
            'prompt': prompt
          });

          hideLoading();

          // æ›´æ–°æœ¬åœ°æ•°æ®
          const knowledge = knowledgeBases.find(kb => kb._id === knowledgeId);
          if (knowledge) {
            knowledge.prompt = prompt;
          }

          showNotification('ä¿å­˜æˆåŠŸ', 'æç¤ºè¯å·²æ›´æ–°', 'success');
          return true;

        } catch (err2) {
          hideLoading();
          console.error('ä¿å­˜æç¤ºè¯å¤±è´¥:', err2);
          showNotification('ä¿å­˜å¤±è´¥', 'æ— æ³•ä¿å­˜æç¤ºè¯ï¼š' + err2.message, 'error');
          return false;
        }
      }
    }

    // æ›´æ–°æç¤ºè¯è®¾ç½®åŒºåŸŸ
    function updatePromptSettings() {
      const promptArea = document.getElementById('promptSettingsArea');
      const promptLabel = document.getElementById('currentKnowledgePromptLabel').querySelector('span');
      const promptTextarea = document.getElementById('promptTextarea');
      
      if (currentKnowledgeBase && knowledgeBases.length > 0) {
        const currentKB = knowledgeBases.find(kb => kb._id === currentKnowledgeBase);
        if (currentKB) {
          promptArea.classList.remove('hidden');
          promptLabel.textContent = currentKB.name;
          promptTextarea.value = currentKB.prompt || 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çŸ¥è¯†åº“åŠ©æ‰‹ï¼Œè¯·æ ¹æ®æä¾›çš„æ–‡æ¡£å†…å®¹å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚';
          updatePromptCharCount();
        } else {
          promptArea.classList.add('hidden');
        }
      } else {
        promptArea.classList.add('hidden');
      }
    }

    // æ›´æ–°æç¤ºè¯å­—ç¬¦è®¡æ•°
    function updatePromptCharCount() {
      const textarea = document.getElementById('promptTextarea');
      const charCount = document.getElementById('promptCharCount');
      
      if (!textarea || !charCount) return; // é˜²æ­¢å…ƒç´ ä¸å­˜åœ¨æ—¶æŠ¥é”™
      
      const currentLength = textarea.value.length;
      charCount.textContent = currentLength;
      
      // è¶…è¿‡é™åˆ¶æ—¶å˜çº¢
      if (currentLength > 500) {
        charCount.classList.add('text-danger');
      } else {
        charCount.classList.remove('text-danger');
      }
    }

    // æ›´æ–°æ·»åŠ çŸ¥è¯†åº“å¼¹çª—ä¸­çš„å­—ç¬¦è®¡æ•°
    function updateAddPromptCharCount() {
      const textarea = document.getElementById('knowledgePrompt');
      const charCount = document.getElementById('addPromptCharCount');
      
      if (!textarea || !charCount) return; // é˜²æ­¢å…ƒç´ ä¸å­˜åœ¨æ—¶æŠ¥é”™
      
      const currentLength = textarea.value.length;
      charCount.textContent = currentLength;
      
      if (currentLength > 500) {
        charCount.classList.add('text-danger');
      } else {
        charCount.classList.remove('text-danger');
      }
    }

    // åˆå§‹åŒ–é¡µé¢
    window.addEventListener('DOMContentLoaded', () => {
      // åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨
      loadKnowledgeBases();

      // ç»‘å®šæ·»åŠ çŸ¥è¯†åº“æŒ‰é’®äº‹ä»¶
      document.getElementById('addKnowledgeBtn').addEventListener('click', () => {
        document.getElementById('knowledgeName').value = '';
        document.getElementById('knowledgeDesc').value = '';
        // é‡ç½®æç¤ºè¯è¾“å…¥æ¡†ä¸ºé»˜è®¤å€¼
        const defaultPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çŸ¥è¯†åº“åŠ©æ‰‹ï¼Œè¯·æ ¹æ®æä¾›çš„æ–‡æ¡£å†…å®¹å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚';
        document.getElementById('knowledgePrompt').value = defaultPrompt;
        updateAddPromptCharCount();
        document.getElementById('nameError').classList.add('hidden');
        document.getElementById('addKnowledgeModal').classList.remove('hidden');
        setTimeout(() => {
          document.getElementById('modalContent').classList.remove('scale-95', 'opacity-0');
          document.getElementById('modalContent').classList.add('scale-100', 'opacity-100');
        }, 10);
      });

      // ç»‘å®šåˆ›å»ºçŸ¥è¯†åº“å–æ¶ˆæŒ‰é’®äº‹ä»¶
      document.getElementById('cancelCreateBtn').addEventListener('click', () => {
        document.getElementById('modalContent').classList.remove('scale-100', 'opacity-100');
        document.getElementById('modalContent').classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
          document.getElementById('addKnowledgeModal').classList.add('hidden');
        }, 300);
      });

      // ç»‘å®šåˆ›å»ºçŸ¥è¯†åº“ç¡®è®¤æŒ‰é’®äº‹ä»¶
      document.getElementById('createKnowledgeBtn').addEventListener('click', async () => {
        const name = document.getElementById('knowledgeName').value.trim();
        const desc = document.getElementById('knowledgeDesc').value.trim();
        const prompt = document.getElementById('knowledgePrompt').value.trim();

        if (!name) {
          document.getElementById('nameError').classList.remove('hidden');
          return;
        }

        // è°ƒç”¨åˆ›å»ºçŸ¥è¯†åº“å‡½æ•°
        const knowledgeId = await createKnowledgeBase(name, desc, prompt);
        if (knowledgeId) {
          // å…³é—­å¼¹çª—
          document.getElementById('modalContent').classList.remove('scale-100', 'opacity-100');
          document.getElementById('modalContent').classList.add('scale-95', 'opacity-0');
          setTimeout(() => {
            document.getElementById('addKnowledgeModal').classList.add('hidden');
          }, 300);
        }
      });

      // ç»‘å®šæ–‡ä»¶ä¸Šä¼ äº‹ä»¶
      document.getElementById('dropArea').addEventListener('click', () => {
        document.getElementById('fileInput').click();
      });

      // æ‹–æ”¾ä¸Šä¼ 
      document.getElementById('dropArea').addEventListener('dragover', (e) => {
        e.preventDefault();
        document.getElementById('dropArea').classList.add('border-primary');
      });

      document.getElementById('dropArea').addEventListener('dragleave', () => {
        document.getElementById('dropArea').classList.remove('border-primary');
      });

      document.getElementById('dropArea').addEventListener('drop', (e) => {
        e.preventDefault();
        document.getElementById('dropArea').classList.remove('border-primary');

        if (e.dataTransfer.files.length > 0 && currentKnowledgeBase) {
          uploadFileToKnowledge(currentKnowledgeBase, e.dataTransfer.files[0]);
        }
      });

      document.getElementById('fileInput').addEventListener('change', (e) => {
        if (e.target.files.length > 0 && currentKnowledgeBase) {
          uploadFileToKnowledge(currentKnowledgeBase, e.target.files[0]);
          e.target.value = ''; // é‡ç½®æ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
        }
      });

      // ç»‘å®šåˆ é™¤ç¡®è®¤äº‹ä»¶
      document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
        const knowledgeId = document.getElementById('deleteKnowledgeName').dataset.id;
        if (knowledgeId) {
          const success = await deleteKnowledgeBase(knowledgeId);
          if (success) {
            closeDeleteConfirmModal();
          }
        }
      });

      // å­—ç¬¦è®¡æ•°
      document.getElementById('searchInput').addEventListener('input', (e) => {
        const count = e.target.value.length;
        document.getElementById('charCount').textContent = count;

        // é™åˆ¶æœ€å¤§å­—ç¬¦æ•°
        if (count > 500) {
          e.target.value = e.target.value.substring(0, 500);
          document.getElementById('charCount').textContent = 500;
        }
      });

      // æ¸…ç©ºè¾“å…¥æ¡†
      document.getElementById('clearBtn').addEventListener('click', () => {
        const searchInput = document.getElementById('searchInput');
        searchInput.value = '';
        searchInput.focus();
        document.getElementById('charCount').textContent = '0';
      });

      // å‘é€æœç´¢è¯·æ±‚ï¼ˆæ­¤å¤„ä»…ä¸ºç¤ºä¾‹ï¼Œå®é™…åº”æ ¹æ®åç«¯APIè°ƒæ•´ï¼‰
      document.getElementById('searchBtn').addEventListener('click', async () => {
        const query = document.getElementById('searchInput').value.trim();
        if (!query || !currentKnowledgeBase) return;

        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('searchInput').value = '';
        document.getElementById('charCount').textContent = '0';

        // æ˜¾ç¤ºç”¨æˆ·è¾“å…¥
        const conversationContainer = document.getElementById('conversationContainer');
        const userMessage = document.createElement('div');
        userMessage.className = 'flex items-start justify-end mb-6';
        userMessage.innerHTML = `
          <div class="max-w-[85%]">
            <div class="bg-primary text-white p-4 message-bubble-right">
              <p>${query}</p>
            </div>
            <span class="text-xs text-gray-400 mr-3 mt-1 block text-right">ä½ </span>
          </div>
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white ml-3 shadow-md">
            <i class="fa fa-user text-sm"></i>
          </div>
        `;
        conversationContainer.appendChild(userMessage);

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const loadingMessage = document.createElement('div');
        loadingMessage.className = 'flex items-start mb-6 loading-message';
        loadingMessage.innerHTML = `
          <div class="flex-shrink-0 w-8 h-8 rounded-full overflow-hidden shadow-md">
            <img src="pic/Book.png" alt="æ™ºèƒ½åŠ©æ‰‹" class="w-full h-full object-cover">
          </div>
          <div class="ml-3 max-w-[85%]">
            <div class="bg-gray-100 p-4 message-bubble-left">
              <div class="flex space-x-2">
                <div class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay: 300ms"></div>
              </div>
            </div>
          </div>
        `;
        conversationContainer.appendChild(loadingMessage);

        // æ»šåŠ¨åˆ°åº•éƒ¨
        conversationContainer.scrollTop = conversationContainer.scrollHeight;

        try {
          // è°ƒç”¨åç«¯APIè·å–æ™ºèƒ½å›ç­”
          const response = await apiRequest('/query', 'POST', {
            knowledge_base_id: currentKnowledgeBase,
            query: query
          });

          // ç§»é™¤åŠ è½½çŠ¶æ€
          const loadingMessageEl = document.querySelector('.loading-message');
          if (loadingMessageEl) {
            loadingMessageEl.remove();
          }

          // ä¼˜å…ˆä½¿ç”¨å¤§æ¨¡å‹å›ç­”ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ä¼ ç»Ÿç­”æ¡ˆ
          let finalAnswer = response.llm_answer || response.answer;
          
          // ä¿®å¤é—®é¢˜3ï¼šç»„åˆåŸå§‹æ–‡æ¡£ç»“æœå’ŒAIå›å¤
          let combinedAnswer = '';
          
          // å¦‚æœæœ‰åŸå§‹æ–‡æ¡£ç»“æœï¼Œå…ˆæ˜¾ç¤º
          if (response.answer && response.answer !== response.llm_answer) {
            combinedAnswer += `<div class="mb-3 p-3 bg-blue-50 border-l-4 border-blue-400 rounded-r">
              <div class="text-xs font-medium text-blue-700 mb-2 flex items-center">
                <i class="fa fa-file-text-o mr-1"></i>æ–‡æ¡£æ£€ç´¢ç»“æœ
              </div>
              <div class="text-sm text-blue-800">${response.answer.replace(/\n/g, '<br>')}</div>
            </div>`;
          }
          
          // å¦‚æœæœ‰AIå›å¤ï¼Œå†æ˜¾ç¤º
          if (response.llm_answer) {
            combinedAnswer += `<div class="p-3 bg-green-50 border-l-4 border-green-400 rounded-r">
              <div class="text-xs font-medium text-green-700 mb-2 flex items-center">
                <i class="fa fa-magic mr-1"></i>AIæ™ºèƒ½å›ç­”-åŸºäºè±†åŒ… 1.5Proæ¨¡å‹
              </div>
              <div class="text-sm text-green-800">${response.llm_answer.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}</div>
            </div>`;
          }
          
          // å¦‚æœéƒ½æ²¡æœ‰ï¼Œä½¿ç”¨é»˜è®¤å›ç­”
          if (!combinedAnswer) {
            combinedAnswer = finalAnswer.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
          }

          // è·å–å½“å‰çŸ¥è¯†åº“åç§°ç”¨äºæ˜¾ç¤ºï¼ˆä¿®å¤é—®é¢˜4ï¼‰
          const currentKB = knowledgeBases.find(kb => kb._id === currentKnowledgeBase);
          const knowledgeBaseName = currentKB ? currentKB.name : 'çŸ¥è¯†åº“';

          // æ˜¾ç¤ºAIå›ç­”
          const aiMessage = document.createElement('div');
          aiMessage.className = 'flex items-start mb-6';
          aiMessage.innerHTML = `
            <div class="flex-shrink-0 w-8 h-8 rounded-full overflow-hidden shadow-md">
              <img src="pic/Book.png" alt="æ™ºèƒ½åŠ©æ‰‹" class="w-full h-full object-cover">
            </div>
            <div class="ml-3 max-w-[85%]">
              <div class="bg-gray-100 p-4 message-bubble-left">
                <div class="prose prose-sm max-w-none">
                  ${combinedAnswer}
                </div>
              </div>
              <span class="text-xs text-gray-400 ml-3 mt-1 block">åŸºäº${knowledgeBaseName}åº“äº§ç”Ÿçš„å›å¤</span>
            </div>
          `;
          conversationContainer.appendChild(aiMessage);
          
          // æ»šåŠ¨åˆ°åº•éƒ¨
          conversationContainer.scrollTop = conversationContainer.scrollHeight;

        } catch (err) {
          // ç§»é™¤åŠ è½½çŠ¶æ€
          const loadingMessageEl = document.querySelector('.loading-message');
          if (loadingMessageEl) {
            loadingMessageEl.remove();
          }

          // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
          const errorMessage = document.createElement('div');
          errorMessage.className = 'flex items-start mb-6';
          
          // è·å–å½“å‰çŸ¥è¯†åº“åç§°ç”¨äºæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          const currentKB = knowledgeBases.find(kb => kb._id === currentKnowledgeBase);
          const knowledgeBaseName = currentKB ? currentKB.name : 'çŸ¥è¯†åº“';
          
          errorMessage.innerHTML = `
            <div class="flex-shrink-0 w-8 h-8 rounded-full overflow-hidden shadow-md">
              <img src="pic/Book.png" alt="æ™ºèƒ½åŠ©æ‰‹" class="w-full h-full object-cover">
            </div>
            <div class="ml-3 max-w-[85%]">
              <div class="bg-red-50 border border-red-200 p-4 message-bubble-left">
                <p class="text-red-700">æŠ±æ­‰ï¼ŒæŸ¥è¯¢è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š${err.message || 'æœªçŸ¥é”™è¯¯'}</p>
                <p class="text-red-600 text-sm mt-2">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚</p>
              </div>
              <span class="text-xs text-gray-400 ml-3 mt-1 block">åŸºäº${knowledgeBaseName}åº“äº§ç”Ÿçš„å›å¤</span>
            </div>
          `;
          conversationContainer.appendChild(errorMessage);
          
          // æ»šåŠ¨åˆ°åº•éƒ¨
          conversationContainer.scrollTop = conversationContainer.scrollHeight;
          
          showNotification('æŸ¥è¯¢å¤±è´¥', err.message || 'æ— æ³•è·å–å›ç­”ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
      });

      // æŒ‰Enterå‘é€æ¶ˆæ¯ï¼ŒShift+Enteræ¢è¡Œ
      document.getElementById('searchInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          document.getElementById('searchBtn').click();
        }
      });

      // æç¤ºè¯ç›¸å…³äº‹ä»¶ç»‘å®š - å»¶è¿Ÿç»‘å®šç¡®ä¿å…ƒç´ å­˜åœ¨
      setTimeout(() => {
        const promptTextarea = document.getElementById('promptTextarea');
        if (promptTextarea) {
          promptTextarea.addEventListener('input', updatePromptCharCount);
          console.log('æç¤ºè¯è¾“å…¥æ¡†äº‹ä»¶å·²ç»‘å®š');
        } else {
          console.warn('æç¤ºè¯è¾“å…¥æ¡†æœªæ‰¾åˆ°');
        }
        
        // ç¡®ä¿æ·»åŠ çŸ¥è¯†åº“å¼¹çª—ä¸­çš„æç¤ºè¯è¾“å…¥æ¡†å­˜åœ¨åå†ç»‘å®šäº‹ä»¶
        const knowledgePromptTextarea = document.getElementById('knowledgePrompt');
        if (knowledgePromptTextarea) {
          knowledgePromptTextarea.addEventListener('input', updateAddPromptCharCount);
          console.log('æ·»åŠ çŸ¥è¯†åº“æç¤ºè¯è¾“å…¥æ¡†äº‹ä»¶å·²ç»‘å®š');
        } else {
          console.warn('æ·»åŠ çŸ¥è¯†åº“æç¤ºè¯è¾“å…¥æ¡†æœªæ‰¾åˆ°');
        }
      }, 100);

      // ä¿å­˜æç¤ºè¯æŒ‰é’®äº‹ä»¶
      document.getElementById('savePromptBtn').addEventListener('click', async () => {
        console.log('ä¿å­˜æç¤ºè¯æŒ‰é’®è¢«ç‚¹å‡»');
        
        if (!currentKnowledgeBase) {
          showNotification('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªçŸ¥è¯†åº“', 'error');
          return;
        }
        
        const promptTextarea = document.getElementById('promptTextarea');
        if (!promptTextarea) {
          showNotification('é”™è¯¯', 'æ‰¾ä¸åˆ°æç¤ºè¯è¾“å…¥æ¡†', 'error');
          return;
        }
        
        const prompt = promptTextarea.value.trim();
        console.log('å½“å‰æç¤ºè¯å†…å®¹:', prompt);
        console.log('å½“å‰çŸ¥è¯†åº“ID:', currentKnowledgeBase);
        
        if (prompt.length > 500) {
          showNotification('é”™è¯¯', 'æç¤ºè¯ä¸èƒ½è¶…è¿‡500ä¸ªå­—ç¬¦', 'error');
          return;
        }
        
        if (prompt.length === 0) {
          showNotification('é”™è¯¯', 'æç¤ºè¯ä¸èƒ½ä¸ºç©º', 'error');
          return;
        }
        
        const success = await updateKnowledgePrompt(currentKnowledgeBase, prompt);
        if (success) {
          // æš‚æ—¶ä¸é‡æ–°åŠ è½½ï¼Œé¿å…ä¸¢å¤±ç”¨æˆ·çš„ä¿®æ”¹
          // await loadKnowledgeBases();
          console.log('æç¤ºè¯ä¿å­˜æˆåŠŸ');
        }
      });

      // é‡ç½®æç¤ºè¯æŒ‰é’®äº‹ä»¶ï¼ˆä¿®å¤é—®é¢˜2ï¼šé‡ç½®æŒ‰é’®æ²¡æœ‰ååº”ï¼‰
      document.getElementById('resetPromptBtn').addEventListener('click', async () => {
        console.log('é‡ç½®æç¤ºè¯æŒ‰é’®è¢«ç‚¹å‡»');
        
        if (!currentKnowledgeBase) {
          showNotification('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªçŸ¥è¯†åº“', 'error');
          return;
        }
        
        const defaultPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çŸ¥è¯†åº“åŠ©æ‰‹ï¼Œè¯·æ ¹æ®æä¾›çš„æ–‡æ¡£å†…å®¹å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚';
        const promptTextarea = document.getElementById('promptTextarea');
        
        if (!promptTextarea) {
          showNotification('é”™è¯¯', 'æ‰¾ä¸åˆ°æç¤ºè¯è¾“å…¥æ¡†', 'error');
          return;
        }
        
        // å…ˆåœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºé‡ç½®åçš„å†…å®¹
        promptTextarea.value = defaultPrompt;
        updatePromptCharCount();
        
        console.log('é‡ç½®åçš„æç¤ºè¯:', defaultPrompt);
        console.log('å½“å‰çŸ¥è¯†åº“ID:', currentKnowledgeBase);
        
        // è‡ªåŠ¨ä¿å­˜é‡ç½®åçš„æç¤ºè¯
        const success = await updateKnowledgePrompt(currentKnowledgeBase, defaultPrompt);
        if (success) {
          showNotification('é‡ç½®æˆåŠŸ', 'æç¤ºè¯å·²é‡ç½®ä¸ºé»˜è®¤å†…å®¹', 'success');
          console.log('æç¤ºè¯é‡ç½®æˆåŠŸ');
        } else {
          // å¦‚æœä¿å­˜å¤±è´¥ï¼Œæ¢å¤åŸæ¥çš„å†…å®¹
          const currentKB = knowledgeBases.find(kb => kb._id === currentKnowledgeBase);
          if (currentKB && currentKB.prompt) {
            promptTextarea.value = currentKB.prompt;
            updatePromptCharCount();
          }
        }
      });

      // ç›‘å¬çŸ¥è¯†åº“åˆ‡æ¢ï¼Œæ›´æ–°æç¤ºè¯è®¾ç½®
      document.addEventListener('knowledgeBaseChanged', () => {
        updatePromptSettings();
      });
    });
  </script>
</body>

</html>